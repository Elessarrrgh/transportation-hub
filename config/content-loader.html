<script>
async function loadEventContent() {
  try {
    // --- Parse URL ---
    const parts = window.location.pathname.split("/").filter(Boolean);
    if (parts.length < 2) return;
    const showKey = parts[0].toLowerCase();
    const route = parts[3];
    const stop = parts[4];
    const hotelSlug = parts[5];

    console.log("URL parts:", parts);

    // --- Fetch content-directory.json ---
    const dirUrl = "https://elessarrrgh.github.io/transportation-hub/config/content-directory.json";
    const directory = await fetch(dirUrl + "?nocache=" + Date.now()).then(r => r.json());
    const showJsonUrl = directory[showKey];
    if (!showJsonUrl) return;

    // --- Fetch show JSON ---
    const showData = await fetch(showJsonUrl + "?nocache=" + Date.now()).then(r => r.json());

    // -------------------------------
    // Hotel Pages
    // -------------------------------
    if (window.location.pathname.includes("/hotels")) {
      if (showData.routes && route && showData.routes[route]) {
        const routeData = showData.routes[route];

        // Wait-time iframe
        if (routeData["wait-time"]) {
          const waitIframe = document.querySelector("#wait-time-accordion iframe.wait-time");
          if (waitIframe) waitIframe.src = routeData["wait-time"];
        }

        // Shuttle flyer
        if (routeData.flyer) {
          const flyerPreview = document.querySelector("#flyer-accordion .flyer-preview img");
          const flyerLink = document.querySelector("#flyer-accordion .view-flyer-button");
          if (flyerPreview) flyerPreview.src = routeData.flyer.preview;
          if (flyerLink) flyerLink.href = routeData.flyer.pdf;
        }

        // Shuttle signage
        if (routeData.sign) {
          const signPreview = document.querySelector("#sign-accordion .sign-preview img");
          const signLink = document.querySelector("#sign-accordion .view-sign-button");
          if (signPreview) signPreview.src = routeData.sign.preview;
          if (signLink) signLink.href = routeData.sign.pdf;
        }

        // Stop-specific content
        if (routeData.stops && stop && routeData.stops[stop]) {
          const stopData = routeData.stops[stop];

          // Panorama
          const panoDiv = document.querySelector("#panorama-accordion .accordion-body");
          if (panoDiv && stopData.panorama) {
            panoDiv.setAttribute("data-iframe-src", stopData.panorama);
          }

          // Directions links (from stopData)
          if (stopData.directions) {
            const appleLink = document.querySelector(".directions-icon-link[aria-label*='Apple']");
            const googleLink = document.querySelector(".directions-icon-link[aria-label*='Google']");

            if (appleLink) appleLink.href = stopData.directions.apple;
            if (googleLink) googleLink.href = stopData.directions.google;
          }
        }
      }

      // Hotel-specific content
      if (showData.hotelsJson && hotelSlug) {
        const hotelsData = await fetch(showData.hotelsJson + "?nocache=" + Date.now()).then(r => r.json());
        const hotelData = hotelsData?.[hotelSlug];

        if (hotelData) {
          // Hotel Map
          const mapBody = document.querySelector("#hotel-map-accordion .accordion-body");
          if (mapBody && hotelData.map) {
            mapBody.setAttribute("data-iframe-src", hotelData.map);
          }

          // Shuttle Schedule (HTML injection)
          if (hotelData.scheduleHtml) {
            const scheduleContainer = document.querySelector("#shuttle-schedule-container");
            if (scheduleContainer) {
              try {
                const scheduleHtml = await fetch(hotelData.scheduleHtml + "?nocache=" + Date.now()).then(r => r.text());
                scheduleContainer.innerHTML = scheduleHtml;
              } catch (e) {
                console.error("Failed to load schedule HTML:", e);
              }
            }
          }

          // Directions text (from hotelData)
          if (hotelData.directionsText) {
            const dirText = document.querySelector(".directions-widget-subtext");
            if (dirText) dirText.textContent = hotelData.directionsText;
          }
        }
      }
    }

    // -------------------------------
    // Landing Page
    // -------------------------------
    if (window.location.pathname.includes("/transport-hub")) {
      const titleEl = document.querySelector("[data-event-base='title']");
      if (titleEl && showData.base?.title) {
        titleEl.innerText = showData.base.title;
      }

      const mapEl = document.querySelector("[data-event-base='event-map']");
      if (mapEl && showData.base?.["event-map"]) {
        mapEl.innerHTML = showData.base["event-map"];
      }
    }

    // -------------------------------
    // Interactive Map Page
    // -------------------------------
    if (window.location.pathname.includes("/interactive-map")) {
      const mapIframe = document.querySelector("iframe.rounded-iframe");
      if (mapIframe && showData["interactive-map"]) {
        mapIframe.src = showData["interactive-map"];
      }
    }

    // -------------------------------
    // Flight Info Page
    // -------------------------------
    if (window.location.pathname.includes("/flight-info")) {
      const flightInfo = showData["flight-info"];
      if (!flightInfo) return;

      const arrivalsIframe = document.querySelector("#arrivals-accordion iframe");
      if (arrivalsIframe && flightInfo["arrivals-widget"]) {
        arrivalsIframe.src = flightInfo["arrivals-widget"];
      }

      const departuresIframe = document.querySelector("#departures-accordion iframe");
      if (departuresIframe && flightInfo["departures-widget"]) {
        departuresIframe.src = flightInfo["departures-widget"];
      }

      const travelIframe = document.querySelector("iframe.airport-travel-preview");
      if (travelIframe && flightInfo["travel-time"]) {
        travelIframe.src = flightInfo["travel-time"];
      }
    }
  } catch (err) {
    console.error("Error loading event content:", err);
  }
}

document.addEventListener("DOMContentLoaded", loadEventContent);
</script>