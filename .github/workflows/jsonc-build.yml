name: Build JSON from JSONC

on:
  push:
    branches:
      - test   # workflow triggers only on your working branch

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the repo with credentials persisted
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true  # ensures workflow can push back

      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # Step 3: Install strip-json-comments
      - name: Install strip-json-comments-cli
        run: npm install -g strip-json-comments-cli

      # Step 4: Convert all .jsonc files to .json
      - name: Convert JSONC to JSON
        run: |
          # Create output folder
          mkdir -p config/show-content
          # Find all .jsonc files in config/ and shows/
          for file in $(find config shows -name '*.jsonc'); do
            # preserve folder structure inside config/show-content
            relative_path="${file#*/}"       # remove first folder (config/ or shows/)
            output_file="config/show-content/$relative_path"
            output_file="${output_file%.*}.json"  # replace .jsonc with .json
            mkdir -p "$(dirname "$output_file")"
            strip-json-comments "$file" > "$output_file"
          done

      # Step 5: Commit cleaned JSON to build-json branch
      - name: Commit cleaned JSON
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Make sure we are in a new branch for output
          git checkout -B build-json
          
          # Stage generated JSON files
          git add config/show-content/*.json config/show-content/*/*.json
          
          # Commit if there are changes
          git diff --cached --quiet || git commit -m "Build: strip comments from JSONC"
          
          # Push to build-json (create branch if it doesn't exist)
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/Elessarrrgh/transportation-hub.git build-json --force
